---
- name: Unmount legacy mount if present (DigitalOcean default)
  ansible.posix.mount:
    path: "{{ legacy_mount_path }}"
    state: unmounted
  ignore_errors: true

- name: Remove legacy fstab entry if present
  ansible.posix.mount:
    path: "{{ legacy_mount_path }}"
    state: absent
  ignore_errors: true

- name: Remove legacy mount directory if empty
  ansible.builtin.file:
    path: "{{ legacy_mount_path }}"
    state: absent
  ignore_errors: true

- name: Create mount point
  ansible.builtin.file:
    path: "{{ mount_path }}"
    state: directory
    mode: "0755"

- name: Mount block storage at desired path
  ansible.posix.mount:
    path: "{{ mount_path }}"
    src: "{{ volume_device }}"
    fstype: ext4
    opts: defaults,nofail,noatime
    state: mounted

- name: Create Docker data root and services directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - "{{ docker_dir }}"
    - "{{ services_dir }}"

- name: Create nginx proxy manager data directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ npm_uid }}"
    group: "{{ npm_gid }}"
    mode: "0755"
  loop: "{{ npm_dirs }}"

- name: Create nginx proxy manager database directory
  ansible.builtin.file:
    path: "{{ npm_db_dir }}"
    state: directory
    owner: "{{ mariadb_uid }}"
    group: "{{ mariadb_gid }}"
    mode: "0750"

- name: Create pelican data directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop: "{{ pelican_dirs }}"

- name: Create pelican database directory
  ansible.builtin.file:
    path: "{{ pelican_db_dir }}"
    state: directory
    owner: "{{ mariadb_uid }}"
    group: "{{ mariadb_gid }}"
    mode: "0750"

- name: Create pelican mount directory
  ansible.builtin.file:
    path: "{{ pelican_mount_path }}"
    state: directory
    mode: "0755"

- name: Show resulting mount and layout
  ansible.builtin.command: df -h "{{ mount_path }}"
  register: mount_df
  changed_when: false

- name: Debug layout paths
  ansible.builtin.debug:
    msg:
      - "Mounted at: {{ mount_path }}"
      - "Docker root candidate: {{ docker_dir }}"
      - "Services root: {{ services_dir }}"
      - "NPM data: {{ npm_dirs }}"
