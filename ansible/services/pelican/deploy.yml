---
- name: Install Pelican dependencies
  ansible.builtin.apt:
    name:
      - software-properties-common
      - curl
      - ca-certificates
      - gnupg
      - lsb-release
      - certbot
      - tar
      - unzip
      - git
      - redis-tools
      - nginx
    state: present
    update_cache: true

- name: Add PHP repository
  ansible.builtin.apt_repository:
    repo: ppa:ondrej/php
    state: present

- name: Install PHP 8.3 and extensions
  ansible.builtin.apt:
    name:
      - php8.3
      - php8.3-cli
      - php8.3-gd
      - php8.3-mysql
      - php8.3-pdo
      - php8.3-mbstring
      - php8.3-tokenizer
      - php8.3-bcmath
      - php8.3-xml
      - php8.3-fpm
      - php8.3-curl
      - php8.3-zip
      - php8.3-intl
      - php8.3-redis
      - php8.3-sqlite3
    state: present
    update_cache: true

- name: Create docker-compose.yml for pelican database
  ansible.builtin.copy:
    src: docker-compose.yml
    dest: "{{ pelican_mount_path }}/docker-compose.yml"
    owner: root
    group: root
    mode: "0644"

- name: Start pelican database and redis via docker-compose
  community.docker.docker_compose_v2:
    project_src: "{{ pelican_mount_path }}"
    state: present

- name: Download Composer installer
  ansible.builtin.get_url:
    url: https://getcomposer.org/installer
    dest: /tmp/composer-setup.php
    mode: "0755"

- name: Install Composer globally
  ansible.builtin.command: php /tmp/composer-setup.php --install-dir=/usr/local/bin --filename=composer
  args:
    creates: /usr/local/bin/composer

- name: Create pelican web directory
  ansible.builtin.file:
    path: /var/www/pelican
    state: directory
    owner: www-data
    group: www-data
    mode: "0755"

- name: Check if Pelican is already installed
  ansible.builtin.stat:
    path: /var/www/pelican/composer.json
  register: pelican_installed

- name: Download and install Pelican panel
  when: not pelican_installed.stat.exists
  block:
    - name: Download Pelican panel
      ansible.builtin.get_url:
        url: https://github.com/pelican-dev/panel/releases/latest/download/panel.tar.gz
        dest: /tmp/panel.tar.gz
        mode: "0644"

    - name: Extract Pelican panel
      ansible.builtin.unarchive:
        src: /tmp/panel.tar.gz
        dest: /var/www/pelican
        remote_src: true
        owner: www-data
        group: www-data

    - name: Set correct permissions on storage and cache
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: www-data
        group: www-data
        mode: "0755"
        recurse: true
      loop:
        - /var/www/pelican/storage
        - /var/www/pelican/bootstrap/cache

- name: Install Composer dependencies
  become_user: www-data
  ansible.builtin.command: composer install --no-dev --optimize-autoloader
  args:
    chdir: /var/www/pelican
    creates: /var/www/pelican/vendor/autoload.php

- name: Check if .env file exists
  ansible.builtin.stat:
    path: /var/www/pelican/.env
  register: pelican_env

- name: Configure Pelican environment
  when: not pelican_env.stat.exists
  block:
    - name: Copy .env.example to .env
      ansible.builtin.copy:
        src: /var/www/pelican/.env.example
        dest: /var/www/pelican/.env
        owner: www-data
        group: www-data
        mode: "0640"
        remote_src: true

    - name: Set APP_KEY from environment variable
      ansible.builtin.lineinfile:
        path: /var/www/pelican/.env
        regexp: "^APP_KEY="
        line: "APP_KEY={{ lookup('env', 'PELICAN_APP_KEY') }}"
        owner: www-data
        group: www-data
        mode: "0640"
      when: lookup('env', 'PELICAN_APP_KEY') != ''

    - name: Generate application key if not provided
      become_user: www-data
      ansible.builtin.command: php artisan key:generate --force
      args:
        chdir: /var/www/pelican
      when: lookup('env', 'PELICAN_APP_KEY') == ''

    - name: Configure database in .env
      ansible.builtin.lineinfile:
        path: /var/www/pelican/.env
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        owner: www-data
        group: www-data
        mode: "0640"
      loop:
        - { regexp: "^DB_CONNECTION=", line: "DB_CONNECTION=mysql" }
        - { regexp: "^DB_HOST=", line: "DB_HOST=127.0.0.1" }
        - { regexp: "^DB_PORT=", line: "DB_PORT=3306" }
        - { regexp: "^DB_DATABASE=", line: "DB_DATABASE=panel" }
        - { regexp: "^DB_USERNAME=", line: "DB_USERNAME=pelican" }
        - { regexp: "^DB_PASSWORD=", line: "DB_PASSWORD=pelican" }
        - { regexp: "^REDIS_HOST=", line: "REDIS_HOST=127.0.0.1" }
        - { regexp: "^REDIS_PORT=", line: "REDIS_PORT=6379" }
        - { regexp: "^CACHE_DRIVER=", line: "CACHE_DRIVER=redis" }
        - { regexp: "^SESSION_DRIVER=", line: "SESSION_DRIVER=redis" }
        - { regexp: "^QUEUE_CONNECTION=", line: "QUEUE_CONNECTION=redis" }
        - { regexp: "^APP_URL=", line: "APP_URL=https://pelican.{{ domain }}" }

    - name: Wait for database to be ready
      ansible.builtin.wait_for:
        host: 127.0.0.1
        port: 3306
        delay: 5
        timeout: 60

    - name: Run database migrations
      become_user: www-data
      ansible.builtin.command: php artisan migrate --seed --force
      args:
        chdir: /var/www/pelican
      register: migrate_result
      changed_when: "'Migrating' in migrate_result.stdout"

    - name: Create admin user
      become_user: www-data
      ansible.builtin.shell: |
        php artisan p:user:make \
          --email=admin@example.com \
          --username=admin \
          --password=changeme \
          --admin=1
      args:
        chdir: /var/www/pelican
      register: user_create
      failed_when: user_create.rc != 0 and 'already exists' not in user_create.stderr
      changed_when: user_create.rc == 0

- name: Ensure database configuration is present in .env
  ansible.builtin.lineinfile:
    path: /var/www/pelican/.env
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    owner: www-data
    group: www-data
    mode: "0640"
  loop:
    - { regexp: "^DB_CONNECTION=", line: "DB_CONNECTION=mysql" }
    - { regexp: "^DB_HOST=", line: "DB_HOST=127.0.0.1" }
    - { regexp: "^DB_PORT=", line: "DB_PORT=3306" }
    - { regexp: "^DB_DATABASE=", line: "DB_DATABASE=panel" }
    - { regexp: "^DB_USERNAME=", line: "DB_USERNAME=pelican" }
    - { regexp: "^DB_PASSWORD=", line: "DB_PASSWORD=pelican" }
    - { regexp: "^REDIS_HOST=", line: "REDIS_HOST=127.0.0.1" }
    - { regexp: "^REDIS_PORT=", line: "REDIS_PORT=6379" }
    - { regexp: "^CACHE_DRIVER=", line: "CACHE_DRIVER=redis" }
    - { regexp: "^SESSION_DRIVER=", line: "SESSION_DRIVER=redis" }
    - { regexp: "^QUEUE_CONNECTION=", line: "QUEUE_CONNECTION=redis" }
    - { regexp: "^APP_URL=", line: "APP_URL=https://pelican.{{ domain }}" }

- name: Ensure APP_KEY is set from environment variable if provided
  ansible.builtin.lineinfile:
    path: /var/www/pelican/.env
    regexp: "^APP_KEY="
    line: "APP_KEY={{ lookup('env', 'PELICAN_APP_KEY') }}"
    owner: www-data
    group: www-data
    mode: "0640"
  when: lookup('env', 'PELICAN_APP_KEY') != ''

- name: Check whether APP_KEY is present
  ansible.builtin.command: grep -E "^APP_KEY=.+" /var/www/pelican/.env
  register: pelican_app_key
  changed_when: false
  failed_when: false

- name: Generate application key when missing
  become_user: www-data
  ansible.builtin.command: php artisan key:generate --force
  args:
    chdir: /var/www/pelican
  when: pelican_app_key.rc != 0

- name: Create systemd service for Pelican queue worker
  ansible.builtin.copy:
    dest: /etc/systemd/system/pelican-worker.service
    content: |
      [Unit]
      Description=Pelican Queue Worker
      After=redis.service

      [Service]
      User=www-data
      Group=www-data
      Restart=always
      ExecStart=/usr/bin/php /var/www/pelican/artisan queue:work --queue=high,standard,low --sleep=3 --tries=3
      StartLimitInterval=180
      StartLimitBurst=30
      RestartSec=5s

      [Install]
      WantedBy=multi-user.target
    mode: "0644"
  register: worker_service

- name: Reload systemd daemon if service changed
  ansible.builtin.systemd:
    daemon_reload: true
  when: worker_service.changed

- name: Enable and start Pelican queue worker
  ansible.builtin.systemd:
    name: pelican-worker
    enabled: true
    state: started

- name: Restart worker if service definition changed
  ansible.builtin.systemd:
    name: pelican-worker
    state: restarted
  when: worker_service.changed

- name: Start PHP-FPM service
  ansible.builtin.systemd:
    name: php8.3-fpm
    enabled: true
    state: started

- name: Create nginx configuration for Pelican
  ansible.builtin.copy:
    dest: /etc/nginx/sites-available/pelican
    content: |
      server {
          listen 8080;
          server_name _;
          root /var/www/pelican/public;
          index index.php;

          client_max_body_size 100M;

          location / {
              try_files $uri $uri/ /index.php?$query_string;
          }

          location ~ \.php$ {
              fastcgi_split_path_info ^(.+\.php)(/.+)$;
              fastcgi_pass unix:/run/php/php8.3-fpm.sock;
              fastcgi_index index.php;
              include fastcgi_params;
              fastcgi_param PHP_VALUE "upload_max_filesize = 100M \n post_max_size=100M";
              fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
              fastcgi_param HTTP_PROXY "";
              fastcgi_intercept_errors off;
              fastcgi_buffer_size 16k;
              fastcgi_buffers 4 16k;
              fastcgi_connect_timeout 300;
              fastcgi_send_timeout 300;
              fastcgi_read_timeout 300;
          }

          location ~ /\.ht {
              deny all;
          }
      }
    mode: "0644"

- name: Enable Pelican nginx site
  ansible.builtin.file:
    src: /etc/nginx/sites-available/pelican
    dest: /etc/nginx/sites-enabled/pelican
    state: link

- name: Remove default nginx site
  ansible.builtin.file:
    path: /etc/nginx/sites-enabled/default
    state: absent

- name: Test nginx configuration
  ansible.builtin.command: nginx -t
  changed_when: false

- name: Restart nginx
  ansible.builtin.systemd:
    name: nginx
    enabled: true
    state: restarted

- name: Show pelican deployment status
  ansible.builtin.debug:
    msg:
      - "Pelican Panel installed successfully!"
      - "Nginx serving on all interfaces port 8080"
      - "Configure NPM to proxy http://{{ ansible_default_ipv4.address }}:8080"
      - "Default credentials: admin@example.com / changeme"
      - "IMPORTANT: Change the admin password immediately!"
      - "Panel location: /var/www/pelican"
      - "Queue worker running as systemd service: pelican-worker"

# Wings Daemon Installation
- name: Create Wings user
  ansible.builtin.user:
    name: wings
    shell: /bin/bash
    home: /home/wings
    createhome: true
    groups: docker
    append: true
    state: present

- name: Create Pelican SFTP user for Wings
  ansible.builtin.user:
    name: pelican
    shell: /bin/false
    home: /home/pelican
    createhome: true
    state: present

- name: Create Wings system directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: wings
    group: wings
    mode: "0755"
  loop:
    - /var/log/pelican
    - /var/lib/pelican
    - /etc/pelican

- name: Create Wings directory structure on volume
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: wings
    group: wings
    mode: "0755"
  loop:
    - "{{ pelican_mount_path }}/wings"
    - "{{ pelican_mount_path }}/wings/logs"
    - "{{ pelican_mount_path }}/wings/data"
    - "{{ pelican_mount_path }}/wings/etc"
    - "{{ pelican_mount_path }}/wings/lib"

- name: Create Wings data directory on persistent volume
  ansible.builtin.file:
    path: "{{ pelican_mount_path }}/volumes"
    state: directory
    owner: wings
    group: wings
    mode: "0755"

- name: Create symlinks for Wings system directories to persistent storage
  ansible.builtin.file:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    state: link
    owner: wings
    group: wings
    force: true
  loop:
    - { src: "{{ pelican_mount_path }}/wings/logs", dest: "/var/log/pelican" }
    - { src: "{{ pelican_mount_path }}/wings/lib", dest: "/var/lib/pelican" }
    - { src: "{{ pelican_mount_path }}/wings/etc", dest: "/etc/pelican" }

- name: Create logrotate config for Wings
  ansible.builtin.copy:
    dest: /etc/logrotate.d/wings
    owner: root
    group: root
    mode: "0644"
    content: |
      /var/log/pelican/*.log {
        daily
        rotate 7
        compress
        delaycompress
        notifempty
        create 0640 wings wings
        sharedscripts
        postrotate
          systemctl reload wings > /dev/null 2>&1 || true
        endscript
      }

- name: Create Docker network for Pelican Wings
  community.docker.docker_network:
    name: pelican_nw
    state: present
    driver: bridge

- name: Create pelican0 Docker network for Wings
  community.docker.docker_network:
    name: pelican0
    state: present
    driver: bridge
    ipam_config:
      - subnet: 10.200.10.0/24

- name: Copy Wings config.yml from environment variable
  ansible.builtin.copy:
    dest: "{{ pelican_mount_path }}/wings/config.yml"
    owner: wings
    group: wings
    mode: "0640"
    content: "{{ lookup('env', 'WINGS_CONFIG') }}"
  when: lookup('env', 'WINGS_CONFIG') != ''

- name: Warn if Wings config was not provided
  ansible.builtin.debug:
    msg: "WARNING: WINGS_CONFIG environment variable is empty. Wings config must be configured manually."
  when: lookup('env', 'WINGS_CONFIG') == ''

- name: Download Wings binary
  ansible.builtin.get_url:
    url: https://github.com/pelican-dev/wings/releases/latest/download/wings_linux_amd64
    dest: /usr/local/bin/wings
    mode: "0755"
    owner: root
    group: root

- name: Create Wings systemd service
  ansible.builtin.copy:
    dest: /etc/systemd/system/wings.service
    owner: root
    group: root
    mode: "0644"
    content: |
      [Unit]
      Description=Pelican Wings Daemon
      After=docker.service
      Wants=docker.service

      [Service]
      User=wings
      WorkingDirectory=/home/wings
      ExecStart=/usr/local/bin/wings --config={{ pelican_mount_path }}/wings/config.yml
      Restart=always
      RestartSec=5s
      StartLimitInterval=600
      StartLimitBurst=3
      AmbientCapabilities=CAP_CHOWN CAP_SETUID CAP_SETGID CAP_DAC_OVERRIDE

      StandardOutput=journal
      StandardError=journal
      SyslogIdentifier=wings

      [Install]
      WantedBy=multi-user.target
  register: wings_service

- name: Reload systemd daemon for Wings
  ansible.builtin.systemd:
    daemon_reload: true
  when: wings_service.changed

- name: Enable and start Wings service
  ansible.builtin.systemd:
    name: wings
    enabled: true
    state: started

- name: Show Wings deployment status
  ansible.builtin.debug:
    msg:
      - "Wings daemon installed successfully!"
      - "Config location: {{ pelican_mount_path }}/wings/config.yml"
      - "Wings listening on port 8081"
      - "Systemd service: wings"
      - "View logs: journalctl -u wings -f"
