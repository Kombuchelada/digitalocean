---
- name: Create docker-compose.yml for nginx proxy manager
  ansible.builtin.copy:
    src: docker-compose.yml
    dest: "{{ npm_mount_path }}/docker-compose.yml"
    owner: root
    group: root
    mode: '0644'
  register: npm_compose

- name: Restart nginx proxy manager if compose file changed
  block:
    - name: Stop nginx proxy manager
      community.docker.docker_compose_v2:
        project_src: "{{ npm_mount_path }}"
        state: absent
      when: npm_compose.changed

    - name: Start nginx proxy manager via docker-compose
      community.docker.docker_compose_v2:
        project_src: "{{ npm_mount_path }}"
        state: present
      when: npm_compose.changed
  when: npm_compose.changed

- name: Ensure nginx proxy manager is running
  community.docker.docker_compose_v2:
    project_src: "{{ npm_mount_path }}"
    state: present
  when: not npm_compose.changed
  register: npm_output

- name: Show npm deployment status
  ansible.builtin.debug:
    msg:
      - "Nginx Proxy Manager is running"
      - "Access at: http://{{ ansible_host }}:81"
      - "Default credentials: admin@example.com / changeme"
      - "Data persisted at: {{ npm_dirs }}"
