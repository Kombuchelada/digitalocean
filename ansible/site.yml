---
- name: Configure Infrastructure
  hosts: proxy_host
  become: true
  vars:
    volume_device: /dev/disk/by-id/scsi-0DO_Volume_docker-data-volume
    mount_path: /mnt/docker-data
    legacy_mount_path: /mnt/docker_data_volume
    docker_dir: "{{ mount_path }}/docker"
    services_dir: "{{ mount_path }}/services"
    npm_dirs:
      - "{{ services_dir }}/npm/data"
      - "{{ services_dir }}/npm/letsencrypt"
  tasks:
    - name: Include volume setup
      ansible.builtin.include_tasks: volume.yml

    - name: Reset Connection after volume mount
      meta: reset_connection
      
    - name: Wait for SSH to be available after mount
      ansible.builtin.wait_for:
        host: "{{ inventory_hostname }}"
        port: 22
        delay: 2
        timeout: 60

    - name: Include Docker installation
      ansible.builtin.include_tasks: docker.yml

    - name: Include Nginx Proxy Manager deployment
      ansible.builtin.include_tasks: services/nginx-proxy-manager/deploy.yml
