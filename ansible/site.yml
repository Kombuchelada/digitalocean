---
- name: Configure Infrastructure
  hosts: proxy_host
  become: true
  vars:
    volume_device: /dev/disk/by-id/scsi-0DO_Volume_docker-data-volume
    mount_path: /mnt/docker-data
    legacy_mount_path: /mnt/docker_data_volume
    docker_dir: "{{ mount_path }}/docker"
    services_dir: "{{ mount_path }}/services"
    npm_mount_path: "{{ mount_path }}/npm"
    npm_dirs:
      - "{{ services_dir }}/npm/data"
      - "{{ services_dir }}/npm/letsencrypt"
    npm_db_dir: "{{ services_dir }}/npm/db"
    npm_uid: 1000
    npm_gid: 1000
    mariadb_uid: 999
    mariadb_gid: 999
    pelican_mount_path: "{{ services_dir }}/pelican"
    pelican_dirs:
      - "{{ services_dir }}/pelican/var"
      - "{{ services_dir }}/pelican/nginx"
      - "{{ services_dir }}/pelican/certs"
      - "{{ services_dir }}/pelican/logs"
    pelican_db_dir: "{{ services_dir }}/pelican/db"
    stashapp_mount_path: "{{ mount_path }}/stashapp"
    emby_mount_path: "{{ services_dir }}/emby"
    emby_config_dir: "{{ emby_mount_path }}/config"
    emby_media_dir: "{{ emby_mount_path }}/media"
    emby_dad_media_dir: "{{ emby_mount_path }}/dad-media"
    emby_dirs:
      - "{{ emby_config_dir }}"
      - "{{ emby_media_dir }}"
    zulip_mount_path: "{{ services_dir }}/zulip"
    zulip_data_dir: "{{ zulip_mount_path }}/data"
    zulip_postgres_dir: "{{ zulip_mount_path }}/postgresql-14"
    zulip_rabbitmq_dir: "{{ zulip_mount_path }}/rabbitmq"
    zulip_redis_dir: "{{ zulip_mount_path }}/redis"
    zulip_external_host: "{{ lookup('env', 'ZULIP_EXTERNAL_HOST') | default('zulip.' + domain, true) }}"
    zulip_admin_email: "{{ lookup('env', 'ZULIP_ADMIN_EMAIL') | default('admin@' + domain, true) }}"
    zulip_http_port: "{{ lookup('env', 'ZULIP_HTTP_PORT') | default('8081', true) }}"
    zulip_loadbalancer_ips: "{{ lookup('env', 'ZULIP_LOADBALANCER_IPS') | default('172.18.0.0/16', true) }}"
    domain: "{{ lookup('env', 'DOMAIN') }}"
  tasks:
    - name: Include volume setup
      ansible.builtin.include_tasks: volume.yml
    - name: Include Docker installation
      ansible.builtin.include_tasks: docker.yml

    - name: Include Nginx Proxy Manager deployment
      ansible.builtin.include_tasks: services/nginx-proxy-manager/deploy.yml

    - name: Include Pelican Game Server deployment
      ansible.builtin.include_tasks:
        file: services/pelican/deploy.yml
        apply:
          tags:
            - pelican
      tags:
        - pelican
      when: enable_pelican | default(false)

    - name: Include Stashapp deployment
      ansible.builtin.include_tasks:
        file: services/stashapp/deploy.yml
        apply:
          tags:
            - stash
      tags:
        - stash

    - name: Include Emby deployment
      ansible.builtin.include_tasks: services/emby/deploy.yml

    - name: Include Zulip deployment
      ansible.builtin.include_tasks:
        file: services/zulip/deploy.yml
        apply:
          tags:
            - zulip
      tags:
        - zulip
      # when: enable_zulip | default(false)
